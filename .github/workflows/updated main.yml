name: Gemini AI Auto Commit and Deploy

on:
  push:
    branches:
      - main

jobs:
  ai-commit-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install latest Gemini GenAI SDK
      - name: Install Dependencies
        run: |
          pip install --upgrade google-genai

      # 4Ô∏è‚É£ Run Gemini AI to auto-update website UI
      - name: Run Gemini AI to Update Website UI
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import subprocess
          import re
          from pathlib import Path
          from google import genai

          # Initialize Gemini client
          client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])

          prompt = """
          GOAL

            Create a high-end, minimalist e-commerce website for premium home goods named ‚Äúpage‚Äù.
            
            The site should feel quiet, refined, and editorial, emphasizing intentional living and timeless design.
            
            AESTHETIC (STRICT)
            
            Design style: Soft Minimalism
            
            Color palette:
            
            Background: #F5F5F0
            
            Secondary surfaces: #D6CFC7
            
            Primary text: #4A4540
            
            Typography:
            
            Clean sans-serif only (Inter or System UI)
            
            Clear hierarchy using font size and weight, not excessive color
            
            Layout:
            
            Ample negative space (minimum 80px padding for major sections)
            
            Calm, balanced compositions
            
            UI details:
            
            Subtle borders
            
            Soft hover transitions
            
            No harsh shadows or loud effects
            
            CONSTRAINTS (NON-NEGOTIABLE)
            1. Images
            
            Use ONLY image paths from assets/images/
            
            Never generate or reference external images
            
            If a specific image is unknown:
            
            Use a neutral colored <div> with a subtle border as a product placeholder
            
            2. Naming
            
            Site name is ‚Äúpage‚Äù
            
            All navigation labels and internal references must include the word ‚Äúpage‚Äù
            
            Examples:
            
            ‚ÄúAbout page‚Äù
            
            ‚ÄúProduct page‚Äù
            
            ‚ÄúHome page‚Äù
            
            3. Structure
            
            Generate semantic HTML5
            
            Use Tailwind CSS (utility-first) or equivalent utility-style internal CSS
            
            No backend, no frameworks, no external libraries
            
            PAGES TO GENERATE
            1. Home page
            
            Minimal hero section with a strong typographic statement:
            
            Theme: ‚ÄúCurated Living‚Äù
            
            Short philosophy statement about calm, intentional home living
            
            Featured collection grid (2‚Äì3 items)
            
            Subtle hover states on products
            
            2. Product Listing Page (PLP)
            
            Clean 2-column (desktop 3-column optional) product grid
            
            Each product card includes:
            
            Product name
            
            Price
            
            Image from assets/images/ OR placeholder div
            
            Gentle hover interaction (opacity shift, border change, or translateY)
            
            3. Product Detail Page (PDP)
            
            Strong focus on typography and whitespace
            
            Elements:
            
            Product name
            
            Price
            
            Detailed description
            
            ‚ÄúAdd to Bag‚Äù button (visual interaction only)
            
            Button interaction:
            
            Hover and active states
            
            No cart logic required
            
            4. About Section
            
            Write 3 meaningful paragraphs about ‚Äúpage‚Äù:
            
            Paragraph 1: Craftsmanship and intentional design
            
            Paragraph 2: Sustainability, materials, and longevity
            
            Paragraph 3: The ‚Äúquiet home‚Äù movement and mindful living
            
            Tone: thoughtful, warm, premium, and human
            
            INTERACTIVITY (STATIC ONLY)
            
            Add:
            
            Hover states
            
            Focus styles
            
            Smooth CSS transitions
            
            No JavaScript frameworks
            
            Interactions must feel calm and refined
            
            OUTPUT REQUIREMENTS
            
            Provide a single HTML file
            
            Include internal CSS or Tailwind-style utilities
            
            Fully responsive (mobile-first)
            
            Clean, readable, well-commented code
            
            FINAL EXPECTATION
            
            The final result should feel like a luxury boutique e-commerce brand ‚Äî
            quiet, confident, editorial, and timeless ‚Äî with no visual clutter.
          Return each file strictly in the format:
          ---filename.ext---
          <file content>
          """

          # Generate content
          response = client.models.generate_content(
              model="gemini-2.5-flash",
              contents=prompt
          )

          output = response.text

          # Parse and write files
          matches = re.findall(r"---(.*?)---\n(.*?)(?=(?:---|$))", output, re.DOTALL)

          for filename, content in matches:
              path = Path(filename.strip())
              path.parent.mkdir(parents=True, exist_ok=True)
              path.write_text(content.strip(), encoding="utf-8")

          # Git commit & push
          subprocess.run(["git", "config", "--global", "user.name", "gemini-bot"])
          subprocess.run(["git", "config", "--global", "user.email", "bot@example.com"])
          subprocess.run(["git", "add", "."])
          subprocess.run(["git", "commit", "-m", "ü§ñ Gemini AI updated website UI"], check=False)
          subprocess.run(["git", "push"])
          EOF

      # 5Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # 6Ô∏è‚É£ Deploy to S3
      - name: Deploy to S3
        run: |
          aws s3 sync . s3://staticwebzsitegit --delete
