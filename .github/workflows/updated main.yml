name: Gemini AI Auto Commit and Deploy

on:
  push:
    branches:
      - main

jobs:
  ai-commit-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install latest Gemini GenAI SDK
      - name: Install Dependencies
        run: |
          pip install --upgrade google-genai

      # 4Ô∏è‚É£ Run Gemini AI to auto-update website UI
      - name: Run Gemini AI to Update Website UI
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import subprocess
          import re
          from pathlib import Path
          from google import genai

          # Initialize Gemini client
          client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])

          prompt = """
          Act as a senior frontend engineer and product designer.
          
          Your task is to ENHANCE an existing static e-commerce website by adding
          realistic, user-centric features that improve usability, trust, and
          shopping flow ‚Äî without overengineering.
          
          CONSTRAINTS
          - Keep the site static (HTML + CSS + minimal vanilla JS only)
          - No backend logic
          - No external frameworks or libraries
          - No external images or APIs
          - Features must degrade gracefully if JS is disabled
          
          GOALS
          - Make the site feel more complete and functional
          - Improve browsing, product discovery, and purchase confidence
          - Maintain a clean, restrained UI (no clutter)
          
          FEATURES TO ADD
          
          1. Navigation & Structure
          - Sticky header with section awareness
          - Clear page hierarchy and breadcrumbs
          - Footer with policy and information links
          
          2. Product Discovery
          - Category filtering (client-side)
          - Price sorting (low to high / high to low)
          - ‚ÄúNew‚Äù or ‚ÄúFeatured‚Äù product indicators
          - Search input with instant filtering
          
          3. Product Detail Enhancements
          - Size / variant selector (visual only)
          - Expandable sections for:
            - Description
            - Materials & care
            - Shipping & returns
          - Related products section
          
          4. Shopping Interaction
          - Client-side cart preview (localStorage)
          - Add / remove items visually
          - Quantity selector
          - Subtle cart feedback animation
          
          5. Trust & UX Signals
          - Shipping information
          - Return policy preview
          - Sustainability or craftsmanship badges
          - Empty-state messaging
          
          6. Accessibility & UX
          - Keyboard-navigable components
          - Focus states
          - ARIA labels where appropriate
          - Reduced-motion support
          
          7.UI FEATURES TO ADD
          1. Navigation & Orientation
          - Sticky header with subtle background change on scroll
          - Active navigation state indicator
          - Breadcrumb UI for product and detail views
          
          2. Micro-Interactions
          - Button hover and active states
          - Press feedback on ‚ÄúAdd to Cart / Add to Bag‚Äù
          - Card hover elevation or outline shift
          - Smooth focus transitions for inputs and links
          
          3. Visual Feedback
          - Loading or processing indicators (CSS-based)
          - Disabled button states with clear affordances
          - Inline status messaging (non-modal)
          
          4. Layout Polish
          - Improved vertical rhythm and spacing consistency
          - Section separators using light rules or spacing
          - Responsive typography scaling
          - Content alignment refinements
          
          5. Component Enhancements
          - Reusable button styles (primary, secondary, ghost)
          - Form field focus and error states
          - Tag / badge components (e.g., ‚ÄúNew‚Äù, ‚ÄúFeatured‚Äù)
          - Price styling hierarchy (currency, amount, metadata)
          
          6. Empty & Edge States
          - Empty product grid message
          - Empty cart UI state
          - No-results search UI
          - Graceful fallbacks for missing images
                    OUTPUT REQUIREMENTS
                    - Update the existing HTML structure
                    - Add only the necessary CSS and minimal JS
                    - Keep code readable and well-commented
                    - Do NOT rewrite unrelated sections
                    - Explain each added feature briefly in comments
                    
                    FINAL RESULT
                    The site should feel like a believable, thoughtfully designed
                    e-commerce experience ‚Äî complete, calm, and user-friendly.

          Return each file strictly in the format:
          ---filename.ext---
          <file content>
          """

          # Generate content
          response = client.models.generate_content(
              model="gemini-3-flash-preview",
              contents=prompt
          )

          output = response.text

          # Parse and write files
          matches = re.findall(r"---(.*?)---\n(.*?)(?=(?:---|$))", output, re.DOTALL)

          for filename, content in matches:
              path = Path(filename.strip())
              path.parent.mkdir(parents=True, exist_ok=True)
              path.write_text(content.strip(), encoding="utf-8")

          # Git commit & push
          subprocess.run(["git", "config", "--global", "user.name", "gemini-bot"])
          subprocess.run(["git", "config", "--global", "user.email", "bot@example.com"])
          subprocess.run(["git", "add", "."])
          subprocess.run(["git", "commit", "-m", "ü§ñ Gemini AI updated website UI"], check=False)
          subprocess.run(["git", "push"])
          EOF

      # 5Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # 6Ô∏è‚É£ Deploy to S3
      - name: Deploy to S3
        run: |
          aws s3 sync . s3://staticwebzsitegit --delete
