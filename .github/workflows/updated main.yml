name: Gemini AI Auto Commit and Deploy

on:
  push:
    branches:
      - main

jobs:
  ai-commit-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install Gemini SDK
      - name: Install Dependencies
        run: |
          pip install --upgrade google-genai

      # 4Ô∏è‚É£ Run Gemini AI to update website
      - name: Run Gemini AI to Update Website UI
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import subprocess
          import re
          from pathlib import Path
          from google import genai

          # ---------- Detect Available Images ----------
          image_dir = Path("assets/images/products")
          image_dir.mkdir(parents=True, exist_ok=True)

          image_files = [
              f.name for f in image_dir.glob("*")
              if f.suffix.lower() in [".jpg", ".jpeg", ".png", ".webp"]
          ]

          image_list_text = "\n".join(image_files) if image_files else "No images available."

          # ---------- Build Prompt ----------
          prompt = f"""
              ROLE
              You are a senior frontend engineer specializing in refined editorial minimal storefronts.
              
              PROJECT
              Build a fully functional static e-commerce storefront called ‚Äúpage‚Äù.
              
              IMPORTANT
              Return ONE complete HTML file only.
              No external files.
              All CSS and JavaScript must be inside the same HTML document.
              Use only vanilla JavaScript.
              No frameworks.
              
              DESIGN SYSTEM
              Editorial Minimalism.
              Calm, restrained, generous spacing.
              
              Palette:
              Canvas: #FAF9F7
              Panels: #E6E1DB
              Divider: #C2B8AE
              Text: #3F3A36
              
              Typography:
              Single modern sans-serif (Inter or system-ui)
              
              Spacing:
              Minimum 80px vertical section padding.
              
              Images:
              Use only images from:
              assets/images/products/
              
              Available product images:
              {image_list_text}
              
              Use filenames exactly.
              Do NOT invent image names.
              
              FUNCTIONAL REQUIREMENTS
              
              1. CART SYSTEM (Must Work)
              - Clicking ‚ÄúAdd to Bag‚Äù adds product to cart
              - Cart count in header updates live
              - Cart stored in localStorage
              - Cart persists on page refresh
              - Prevent duplicate entries (increase quantity instead)
              - Include minimal cart drawer or modal
              - Allow removing items
              - Show total price
              
              2. SEARCH FUNCTION (Must Work)
              - Search input filters products in real time
              - Filter by product name
              - No page reload
              
              3. PRODUCT GRID
              - Responsive grid
              - 2 columns mobile
              - 3 columns desktop
              - Each product:
                  Image
                  Name
                  Price
                  Add to Bag button
              
              4. ITEM DETAIL SECTION
              - Clicking product shows detail section (single-page behavior)
              - No page reload
              - Use JS to toggle visibility
              
              5. INTERACTIONS
              - Soft transitions only (opacity, transform, border)
              - No dramatic animation
              
              6. BRAND STORY
              Include three refined editorial paragraphs about:
              - Thoughtful making
              - Sustainability
              - Home as intentional space
              
              STRUCTURE
              Single HTML document:
              - Semantic HTML5
              - Internal CSS (utility style or minimal custom CSS)
              - <script> tag at bottom for functionality
              
              OUTPUT FORMAT STRICTLY:
              
              ---index.html---
              <!DOCTYPE html>
              <html>
              ...
              Complete working document
              ...
              </html>
              
              
                        OUTPUT FORMAT STRICTLY:
                        ---index.html---
                        <complete HTML document>
                        """

          # ---------- Initialize Gemini ----------
          client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])

          response = client.models.generate_content(
              model="gemini-3-flash-preview",
              contents=prompt
          )

          output = response.text

          if not output:
              print("Gemini returned empty response. Exiting safely.")
              exit(0)

          # ---------- Extract Files ----------
          matches = re.findall(
              r"---(.*?)---\n(.*?)(?=(?:---|$))",
              output,
              re.DOTALL
          )

          if not matches:
              print("No properly formatted files returned. Exiting safely.")
              exit(0)

          for filename, content in matches:
              path = Path(filename.strip())
              path.parent.mkdir(parents=True, exist_ok=True)
              path.write_text(content.strip(), encoding="utf-8")

          # ---------- Commit Only If Changes Exist ----------
          subprocess.run(["git", "config", "--global", "user.name", "gemini-bot"])
          subprocess.run(["git", "config", "--global", "user.email", "bot@example.com"])
          subprocess.run(["git", "add", "."])

          result = subprocess.run(
              ["git", "diff", "--cached", "--quiet"]
          )

          if result.returncode != 0:
              subprocess.run(
                  ["git", "commit", "-m", "ü§ñ Gemini AI updated website UI"]
              )
              subprocess.run(["git", "push"])
          else:
              print("No changes detected. Skipping commit.")

          EOF

      # 5Ô∏è‚É£ Configure AWS Credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # 6Ô∏è‚É£ Deploy to S3 (Clean Production Sync)
      - name: Deploy to S3
        run: |
          aws s3 sync . s3://staticwebzsitegit \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "__pycache__/*" \
            --exclude "*.py" \
            --delete
