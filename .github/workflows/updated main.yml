name: Gemini AI Auto Commit and Deploy

on:
  push:
    branches:
      - main

jobs:
  ai-commit-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install latest Gemini GenAI SDK
      - name: Install Dependencies
        run: |
          pip install --upgrade google-genai

      # 4Ô∏è‚É£ Run Gemini AI to auto-update website UI
      - name: Run Gemini AI to Update Website UI
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import subprocess
          import re
          from pathlib import Path
          from google import genai

          # Initialize Gemini client
          client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])

          prompt = """
          GOAL: Create a high-end e-commerce site for home goods named "page".
          AESTHETIC: Soft Minimalism. Use earthy tones (#F5F5F0, #D6CFC7, #4A4540), ample negative space (utilize 80px+ padding), and clean sans-serif typography (Inter or System UI).

          CONSTRAINTS:
          1. IMAGES: Only use placeholder paths from 'assets/images/'. If no specific image is known, use a colored <div> with a subtle border to represent the product.
          2. NAMING: The site name is "page". All internal links and references must use the term "page" (e.g., "About page", "Product page").
          3. STRUCTURE: Generate clean HTML5 and Tailwind CSS (or utility-first CSS).

          PAGES TO GENERATE:
          1. Homepage: A hero section with a "Curated Living" philosophy and a featured collection grid.
          2. PLP (Product Listing Page): A refined 2-column or 3-column grid with subtle hover states.
          3. PDP (Product Detail Page): Focus on typography and whitespace. Product name, price, description, and a "Add to Bag" button.
          4. About Section: Write 3 paragraphs of meaningful content about "page". Focus on craftsmanship, sustainability, and the "quiet home" movement.

          OUTPUT: Provide a single-file solution (HTML with internal CSS) that feels cohesive and premium.

          Return each file strictly in the format:
          ---filename.ext---
          <file content>
          """

          # Generate content
          response = client.models.generate_content(
              model="gemini-2.0-flash",
              contents=prompt
          )

          output = response.text

          # Parse and write files
          matches = re.findall(r"---(.*?)---\n(.*?)(?=(?:---|$))", output, re.DOTALL)

          for filename, content in matches:
              path = Path(filename.strip())
              path.parent.mkdir(parents=True, exist_ok=True)
              path.write_text(content.strip(), encoding="utf-8")

          # Git commit & push
          subprocess.run(["git", "config", "--global", "user.name", "gemini-bot"])
          subprocess.run(["git", "config", "--global", "user.email", "bot@example.com"])
          subprocess.run(["git", "add", "."])
          subprocess.run(["git", "commit", "-m", "ü§ñ Gemini AI updated website UI"], check=False)
          subprocess.run(["git", "push"])
          EOF

      # 5Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # 6Ô∏è‚É£ Deploy to S3
      - name: Deploy to S3
        run: |
          aws s3 sync . s3://staticwebzsitegit --delete
