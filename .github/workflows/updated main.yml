name: Gemini AI Auto Commit and Deploy

on:
  push:
    branches:
      - main

jobs:
  ai-commit-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2Ô∏è‚É£ Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ Install latest Gemini GenAI SDK
      - name: Install Dependencies
        run: |
          pip install --upgrade google-genai

      # 4Ô∏è‚É£ Run Gemini AI to auto-update website UI
      - name: Run Gemini AI to Update Website UI
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python << 'EOF'
          import os
          import subprocess
          import re
          from pathlib import Path
          from google import genai

          # Initialize Gemini client
          client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])

          prompt = """
          role: >
            Creative frontend engineer and digital product designer
            focused on tactile, expressive web experiences.
          
          project:
            name: page
            type: static e-commerce site
            domain: contemporary home goods
          
          goal: >
            Build a warm, human-centered storefront that feels textured,
            slow, and approachable, inspired by craft studios and analog materials.
          
          visual_direction:
            style: textured modernism
            colors:
              base_canvas: "#F2EFEA"
              primary_surface: "#C9B8A6"
              secondary_surface: "#9E7E6F"
              highlight_action: "#2F3E46"
            textures:
              approach: subtle grain and paper-like noise using CSS gradients
              edges: slightly imperfect outlines
            typography:
              headings: serif or humanist style
              body: system sans-serif
              contrast: clear distinction between headings and body text
            spacing:
              rhythm: comfortable but irregular
              intent: avoid rigid grids
          
          media_rules:
            allowed_paths: "assets/images/"
            restrictions:
              - no external images
              - no generated images
            fallback:
              type: textured placeholder
              description: soft gradient or grain-based block
          
          naming_conventions:
            brand: page
            navigation_labels:
              - Start page
              - Objects page
              - Story page
              - Detail page
          
          technology:
            output: single HTML file
            markup: semantic HTML5
            styling: internal CSS with utility-inspired structure
            javascript:
              allowed: true
              scope: small UI behaviors only
            forbidden:
              - backend logic
              - external frameworks
              - CSS libraries
          
          structure:
            opening_section:
              layout: asymmetrical editorial
              content:
                headline: philosophy of everyday objects
                supporting_text: off-grid placement
                cue: soft scroll indicator
          
            objects_section:
              layout: staggered masonry-style
              cards:
                visual: image or textured placeholder
                fields:
                  - product name
                  - short description
                  - price
              interaction: gentle hover movement
          
            detail_view:
              layout: vertical storytelling
              features:
                - progressive content reveal
                - sticky add-to-bag button after scroll
              button_behavior:
                hover: subtle shade shift
                focus: calm outline
          
            story_section:
              paragraphs:
                - theme: objects that age gracefully
                - theme: honest materials and making
                - theme: slower, intentional living
              tone:
                - reflective
                - grounded
                - human
          
          interaction_design:
            motion:
              - scroll-based reveals
              - tactile hover feedback
            pacing: slow and deliberate
          
          responsive_behavior:
            mobile:
              feel: printed catalog
              layout: vertical and intimate
            desktop:
              feel: unfolding editorial spread
              behavior: progressive disclosure
            breakpoints:
              philosophy: fluid rather than sharp
          
          delivery:
            format: complete HTML document
            includes:
              - internal CSS
              - minimal vanilla JS if required
            code_quality:
              - readable
              - commented
              - organized
          
          expectation: >
            The final website should feel like a crafted digital object:
            warm, imperfect, expressive, and calm.

          Return each file strictly in the format:
          ---filename.ext---
          <file content>
          """

          # Generate content
          response = client.models.generate_content(
              model="gemini-3-flash-preview",
              contents=prompt
          )

          output = response.text

          # Parse and write files
          matches = re.findall(r"---(.*?)---\n(.*?)(?=(?:---|$))", output, re.DOTALL)

          for filename, content in matches:
              path = Path(filename.strip())
              path.parent.mkdir(parents=True, exist_ok=True)
              path.write_text(content.strip(), encoding="utf-8")

          # Git commit & push
          subprocess.run(["git", "config", "--global", "user.name", "gemini-bot"])
          subprocess.run(["git", "config", "--global", "user.email", "bot@example.com"])
          subprocess.run(["git", "add", "."])
          subprocess.run(["git", "commit", "-m", "ü§ñ Gemini AI updated website UI"], check=False)
          subprocess.run(["git", "push"])
          EOF

      # 5Ô∏è‚É£ Configure AWS credentials
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      # 6Ô∏è‚É£ Deploy to S3
      - name: Deploy to S3
        run: |
          aws s3 sync . s3://staticwebzsitegit --delete
